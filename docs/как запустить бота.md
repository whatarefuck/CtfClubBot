# Руководство по установке и запуску Telegram-бота

## Содержание
- [Требования](#требования)
- [Установка PostgreSQL](#установка-postgresql)
  - [Windows](#установка-на-windows)
  - [MacOS](#установка-на-macos)
  - [Linux (Ubuntu/Debian)](#установка-на-linux-ubuntudebian)
- [Создание базы данных для бота](#создание-базы-данных-для-бота)
- [Клонирование репозитория](#клонирование-репозитория)
- [Настройка виртуального окружения](#настройка-виртуального-окружения)
- [Установка зависимостей](#установка-зависимостей)
- [Настройка конфигурации](#настройка-конфигурации)
  - [Создание бота в Telegram](#создание-бота-в-telegram)
  - [Настройка файла .env](#настройка-файла-env)
- [Миграции базы данных](#миграции-базы-данных)
- [Запуск бота](#запуск-бота)
- [Проверка работоспособности](#проверка-работоспособности)
- [Разработка и отладка](#разработка-и-отладка)
- [Типичные ошибки и их решение](#типичные-ошибки-и-их-решение)

## Требования

Для запуска бота вам потребуется:

- Python 3.9 или выше
- PostgreSQL 12 или выше
- Git
- Доступ к интернету (для взаимодействия с Telegram API)
- Токен Telegram-бота (получается у [@BotFather](https://t.me/BotFather))

## Установка PostgreSQL

### Установка на Windows

1. Скачайте установщик PostgreSQL с [официального сайта](https://www.postgresql.org/download/windows/)
2. Запустите скачанный файл и следуйте инструкциям установщика
3. При установке:
   - Запомните или запишите пароль для пользователя `postgres`
   - Оставьте стандартный порт `5432`
   - Выберите локаль (по умолчанию — Current locale)
   - Установите все компоненты, включая pgAdmin (графический интерфейс)
4. После установки откройте программу pgAdmin для управления базами данных

### Установка на macOS

1. Самый простой способ — использовать Homebrew:
   ```bash
   brew install postgresql
   ```
2. Запустите PostgreSQL как сервис:
   ```bash
   brew services start postgresql
   ```
3. Или можно скачать установщик [Postgres.app](https://postgresapp.com/)

### Установка на Linux (Ubuntu/Debian)

1. Обновите список пакетов:
   ```bash
   sudo apt update
   ```
2. Установите PostgreSQL и утилиту командной строки:
   ```bash
   sudo apt install postgresql postgresql-contrib
   ```
3. Запустите PostgreSQL сервер:
   ```bash
   sudo systemctl start postgresql
   ```
4. Настройте автозапуск при старте системы:
   ```bash
   sudo systemctl enable postgresql
   ```

## Создание базы данных для бота

1. Подключитесь к PostgreSQL с правами пользователя postgres:

   **Windows (через pgAdmin):**
   - Откройте pgAdmin
   - Подключитесь к серверу (введите пароль, указанный при установке)
   - Правой кнопкой на "Databases" → "Create" → "Database"
   - Введите имя базы данных `ctf` и сохраните
   - Аналог PgAdmin - [DBeaver](https://dbeaver.com/docs/dbeaver/Create-Connection/)   
   **macOS/Linux (через терминал):**
   ```bash
   sudo -u postgres psql
   ```

2. Создайте пользователя и базу данных (для macOS/Linux в консоли psql):
   ```sql
   CREATE USER ctf WITH PASSWORD 'ctf';
   CREATE DATABASE ctf OWNER ctf;
   GRANT ALL PRIVILEGES ON DATABASE ctf TO ctf;
   ```

3. Выйдите из консоли PostgreSQL (если использовали терминал):
   ```
   \q
   ```

## Клонирование репозитория

1. Откройте терминал (командную строку)
2. Клонируйте репозиторий проекта:
   ```bash
   git clone https://github.com/your-username/your-bot-repo.git
   cd your-bot-repo
   ```

## Настройка виртуального окружения

Виртуальное окружение позволяет изолировать зависимости проекта от других Python-проектов.

1. Создайте виртуальное окружение:
   ```bash
   # Windows
   python -m venv venv
   
   # macOS/Linux
   python3 -m venv venv
   ```

2. Активируйте виртуальное окружение:
   ```bash
   # Windows (PowerShell)
   .\venv\Scripts\Activate.ps1
   
   # Windows (CMD)
   venv\Scripts\activate.bat
   
   # macOS/Linux
   source venv/bin/activate
   ```

После активации в начале строки терминала должен появиться префикс `(venv)`.

## Установка зависимостей

Установите все необходимые пакеты:

```bash
pip install -r requirements.txt
```

Это установит все зависимости, указанные в файле `requirements.txt`, включая:
- aiogram 3.x
- SQLAlchemy
- alembic
- psycopg2-binary
- python-dotenv
- и другие необходимые библиотеки

## Настройка конфигурации

### Создание бота в Telegram

1. Откройте Telegram и найдите [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot`
3. Следуйте инструкциям BotFather:
   - Введите имя бота (будет отображаться как имя контакта)
   - Введите username бота (должен заканчиваться на `bot`)
4. После успешного создания BotFather отправит вам токен бота - сохраните его для следующего шага

### Настройка файла .env

1. Создайте файл `.env` в корневой директории проекта:
   ```bash
   touch .env  # для macOS/Linux
   # или просто создайте файл через текстовый редактор на Windows
   ```

2. Добавьте в файл следующие переменные:
   ```
   BOT_TOKEN=ваш_токен_от_botfather
   DATABASE_URL=postgresql://ctf:ctf@localhost:5432/ctf
   TEACHER_IDS=ID_преподавателя1,ID_преподавателя2
   SENTRY_DSN=https://1ec97a8cca639cde4c69d8b8597dca04@o4507197457432576.ingest.us.sentry.io/4508985176555520
   ENV=dev
   ```

   Замените `ваш_токен_от_botfather` на токен, полученный от BotFather.
   
   Для получения ID преподавателей:
   1. Начните диалог с ботом [@userinfobot](https://t.me/userinfobot)
   2. Бот ответит вам вашим ID - это число нужно добавить в `TEACHER_IDS`

## Миграции базы данных

Перед запуском бота необходимо создать таблицы в базе данных с помощью миграций Alembic:

```bash
# Убедитесь, что вы находитесь в корневой директории проекта
alembic upgrade head
```

Эта команда применит все миграции и создаст необходимые таблицы в базе данных.

## Запуск бота

Теперь все готово для запуска бота:

```bash
# Убедитесь, что виртуальное окружение активировано
python bot/main.py
```

Если все настроено правильно, вы увидите сообщения о запуске бота в консоли, и бот начнет отвечать на команды в Telegram.

## Проверка работоспособности

1. Откройте Telegram и найдите вашего бота по username, который вы указали при создании
2. Отправьте команду `/start` для начала диалога с ботом
3. Следуйте инструкциям бота для регистрации
4. Проверьте другие команды бота, такие как `/my_tasks`, `/leaderboard` и т.д.

## Разработка и отладка

### Логирование

Бот использует стандартный модуль logging для записи сообщений. Вы можете просматривать логи в консоли или настроить их вывод в файл.

### Тестирование изменений

После внесения изменений в код:
1. Остановите бота (Ctrl+C в консоли)
2. Если вы изменили модели базы данных, создайте новую миграцию:
   ```bash
   alembic revision --autogenerate -m "Описание изменений"
   ```
3. Примените миграцию:
   ```bash
   alembic upgrade head
   ```
4. Запустите бота снова:
   ```bash
   python bot/main.py
   ```

### Фоновые задачи

Бот использует фоновые задачи для синхронизации заданий. Эти задачи запускаются автоматически при старте бота.

## Типичные ошибки и их решение

### Ошибка подключения к базе данных

**Проблема:** 
```
sqlalchemy.exc.OperationalError: (psycopg2.OperationalError) could not connect to server: Connection refused
```

**Решение:**
1. Убедитесь, что PostgreSQL запущен
2. Проверьте правильность URL базы данных в `.env`
3. Убедитесь, что пользователь и база данных созданы

### Ошибка применения миграций

**Проблема:**
```
alembic.script.revision.ResolutionError: No such revision or branch 'head'
```

**Решение:**
1. Проверьте структуру директории `alembic`
2. Убедитесь, что переменная `DATABASE_URL` в файле `.env` корректна
3. Проверьте, что директория `alembic/versions` содержит файлы миграций

### Бот не отвечает на команды

**Проблема:** Бот запущен, но не отвечает на сообщения в Telegram.

**Решение:**
1. Убедитесь, что токен бота правильный
2. Проверьте, нет ли ошибок в логах
3. Проверьте подключение к интернету
4. Если вы используете прокси или VPN, убедитесь, что они не блокируют доступ к API Telegram

### Ошибки при запуске фоновых задач

**Проблема:** Фоновые задачи не запускаются или завершаются с ошибкой.

**Решение:**
1. Проверьте логи на наличие исключений
2. Убедитесь, что у бота есть доступ к необходимым API (например, Root-Me)
3. Проверьте корректность учетных данных для API

---

Это руководство поможет вам настроить и запустить Telegram-бота с нуля. В случае возникновения проблем, не описанных в разделе типичных ошибок, обратитесь к документации используемых библиотек или к более опытным разработчикам проекта.